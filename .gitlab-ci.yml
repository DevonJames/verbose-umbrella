image: golang:latest

stages:
  - build

Build:
  stage: build
  script:
    - apt-get update
    - apt-get install zip -y
    - mkdir -p $GOPATH/src/gitlab.com/mediciland/blockchain/
    - cp -r $CI_PROJECT_DIR $GOPATH/src/gitlab.com/mediciland/blockchain/oip
    - curl -L -s https://github.com/golang/dep/releases/download/v0.5.0/dep-linux-amd64 -o $GOPATH/bin/dep
    - chmod +x $GOPATH/bin/dep
    - go get -u github.com/gobuffalo/packr/v2/packr2
    - cd $GOPATH/src/gitlab.com/mediciland/blockchain/oip
    - dep ensure -v
    - cd $GOPATH/src/gitlab.com/mediciland/blockchain/oip/cmd/oipd && packr2 -v && cd -
    - go test -v -race ./...
    - env GOOS=linux GOARCH=amd64 go build -ldflags
      "-X gitlab.com/mediciland/blockchain/oip/version.GitCommitHash=$(git rev-parse --short HEAD)
      -X gitlab.com/mediciland/blockchain/oip/version.BuildDate=$(date +'%Y.%m.%d.%H%M%S')
      -X gitlab.com/mediciland/blockchain/oip/version.BuiltBy=GitLabCI
      -X 'gitlab.com/mediciland/blockchain/oip/version.GoVersion=$(go version)'
      -s -w" -o oipd gitlab.com/mediciland/blockchain/oip/cmd/oipd
    - tar -czvf $CI_PROJECT_DIR/oipd.linux.amd64.tar.gz oipd
    - env GOOS=darwin GOARCH=amd64 go build -ldflags
      "-X gitlab.com/mediciland/blockchain/oip/version.GitCommitHash=$(git rev-parse --short HEAD)
      -X gitlab.com/mediciland/blockchain/oip/version.BuildDate=$(date +'%Y.%m.%d.%H%M%S')
      -X gitlab.com/mediciland/blockchain/oip/version.BuiltBy=GitLabCI
      -X 'gitlab.com/mediciland/blockchain/oip/version.GoVersion=$(go version)'
      -s -w" -o oipd gitlab.com/mediciland/blockchain/oip/cmd/oipd
    - tar -czvf $CI_PROJECT_DIR/oipd.darwin.amd64.tar.gz oipd
    - env GOOS=windows GOARCH=amd64 go build -ldflags
      "-X gitlab.com/mediciland/blockchain/oip/version.GitCommitHash=$(git rev-parse --short HEAD)
      -X gitlab.com/mediciland/blockchain/oip/version.BuildDate=$(date +'%Y.%m.%d.%H%M%S')
      -X gitlab.com/mediciland/blockchain/oip/version.BuiltBy=GitLabCI
      -X 'gitlab.com/mediciland/blockchain/oip/version.GoVersion=$(go version)'
      -s -w" -o oipd.exe gitlab.com/mediciland/blockchain/oip/cmd/oipd
    - zip $CI_PROJECT_DIR/oipd.windows.amd64.zip oipd.exe
  artifacts:
    paths:
      - oipd.linux.amd64.tar.gz
      - oipd.darwin.amd64.tar.gz
      - oipd.windows.amd64.zip